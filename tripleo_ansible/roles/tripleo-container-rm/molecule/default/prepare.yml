---
# Copyright 2019 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- import_playbook: ../pre-prepare.yml

- name: Prepare
  hosts: all
  become: true
  gather_facts: true
  vars:
    required_packages:
      - docker
      - python-docker-py
      - python-virtualenv
  pre_tasks:
    - name: Set current user fact
      set_fact:
        current_user: "{{ lookup('env','USER') }}"
  roles:
    - role: test_deps
  post_tasks:
    - name: Docker block
      block:
        - name: Install docker
          package:
            name: "{{ required_packages }}"
            state: latest

        - name: Ensure "docker" group exists
          group:
            name: docker
            state: present

        - name: Ensure the ansible user can access docker
          user:
            name: "{{ ansible_user | default(current_user) }}"
            groups: docker

        - name: Start docker
          systemd:
            name: docker
            state: started

        - name: Install python-docker in venv
          pip:
            name: "docker"
            virtualenv: /opt/tripleo-ansible
            virtualenv_site_packages: true

    - name: reset ssh connection to allow user changes to take affect
      meta: reset_connection

    - name: pull an image
      vars:
        ansible_python_interpreter: /opt/tripleo-ansible/bin/python
      docker_image:
        name: fedora:28
        source: pull

    - name: Create a data container
      vars:
        ansible_python_interpreter: /opt/tripleo-ansible/bin/python
      docker_container:
        name: "{{ item }}"
        image: fedora:28
        detach: true
        command: sleep 1d
      with_items:
        - docker-container1
        - docker-container2
